<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <!-- CRITICAL: Prevent zoom on focus and set consistent viewport scale -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>سیستم برآورد هزینه خدمات سه‌بعدی aesthero studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vazirmatn for Persian body text -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <!-- Outfit for the logo -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;600&display=swap" rel="stylesheet">
    
    <style>
        /* Custom font class for the logo (Outfit) */
        .logo-font {
            font-family: 'Outfit', sans-serif;
            letter-spacing: -0.05em; 
        }
        
        /* Base Styles (Vazirmatn for body) */
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #050505;
            color: #e5e5e5;
            overflow-x: hidden; 
            padding-bottom: 250px; /* Space for the fixed footer */
        }
        
        /* Input/Select Styling */
        .studio-input, .studio-select {
            background: transparent;
            border: 1px solid #333;
            color: #fff;
            transition: all 0.3s ease;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .studio-input:focus, .studio-select:focus { border-color: #fff; outline: none; box-shadow: 0 0 0 1px rgba(255,255,255,0.1); }
        .studio-select option { background-color: #050505; color: #fff; }
        .select-card { border: 1px solid #262626; background: #0a0a0a; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); padding-top: 1.25rem; padding-bottom: 1.25rem; }
        .select-card:hover { border-color: #525252; transform: translateY(-2px); }
        .select-card.active { background: #fff; border-color: #fff; color: #000; }
        .select-card.active .sub-text { color: #525252; }
        .btn-primary { background: #fff; color: #000; border: 1px solid #fff; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); opacity: 0; visibility: hidden; transform: translateY(10px); }
        .btn-primary:hover { background: transparent; color: #fff; box-shadow: 0 0 20px rgba(255,255,255,0.1); }
        .btn-primary.loading { background: #525252; color: #ccc; cursor: wait; pointer-events: none; }


        /* Counter Button (30% larger) */
        .btn-counter { 
            width: 44px; 
            height: 44px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border: 1px solid #333; 
            border-radius: 4px; 
            cursor: pointer; 
            transition: all 0.2s; 
            font-size: 1.4rem; 
        }
        .btn-counter:hover:not(.disabled) { background: #fff; color: #000; border-color: #fff; }
        .btn-counter.disabled { opacity: 0.2; cursor: not-allowed; border-color: #222; }

        /* SLIDER STYLING */
        .studio-slider {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            height: 10px;
            background: transparent;
            margin: 10px 0;
            cursor: pointer;
        }
        .studio-slider::-webkit-slider-runnable-track { height: 2px; background: #333; border-radius: 1px; transition: all 0.3s; }
        .studio-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px; 
            height: 16px; 
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            margin-top: -7px; 
            transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .studio-slider:hover::-webkit-slider-thumb { transform: scale(1.3); }
        
        /* Validation/Error Highlight */
        .error-highlight {
            border-color: #f87171 !important; 
            box-shadow: 0 0 10px rgba(248, 113, 113, 0.8);
            animation: pulse-slow 1.5s 2 alternate forwards; 
        }
        @keyframes pulse-slow {
            0% { box-shadow: 0 0 5px rgba(248, 113, 113, 0.5); }
            100% { box-shadow: 0 0 15px rgba(248, 113, 113, 1); }
        }
        
        /* Message Display */
        #validationMessage {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(-20px);
        }
        #validationMessage.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        /* FOOTER PORTRAIT STYLING */
        .glass-footer {
            background: rgba(5, 5, 5, 0.9);
            backdrop-filter: blur(12px);
            border-top: 1px solid #262626;
            transition: all 0.5s ease-in-out;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .glass-footer.resize { padding-top: 2rem; padding-bottom: 2rem; }
        .glass-footer.resize .btn-primary { opacity: 1; visibility: visible; transform: translateY(0); }
        .glass-footer.resize #totalCostDisplay { font-size: 2.8rem; } 
        .glass-footer.resize .md\:flex > div .text-white { font-size: 0.85rem; }


        /* LANDSCAPE MODE STYLING */
        @media (orientation: landscape) and (max-width: 1024px) {
            .main-content-wrapper {
                margin-right: 0;
                margin-left: 200px; 
                padding-left: 1rem;
                transition: margin-left 0.5s ease-in-out; 
            }

            .glass-footer {
                top: 0;
                bottom: 0;
                right: auto;
                left: 0;
                width: 200px; 
                height: 100vh;
                border-top: none;
                border-right: 1px solid #262626;
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
                padding: 1.5rem 1rem;
                transition: all 0.5s ease-in-out, width 0.5s ease-in-out;
            }

            .glass-footer.resize { width: 280px; }
            .glass-footer.resize #totalCostDisplay { font-size: 3.8rem; }
            .glass-footer.resize .md\:flex > div .text-white { font-size: 0.85rem; }
            .glass-footer.resize .btn-primary { opacity: 1; visibility: visible; }
            
            .main-content-wrapper.resize { margin-left: 280px; }
            
            .glass-footer .md\:hidden { display: none !important; }
            body { padding-bottom: 0 !important; } 
        }
        
        /* Modal Styling */
        #successModal {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        #successModal.active {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    
    <!-- Temporary Floating Validation Message -->
    <div id="validationMessage" class="fixed top-0 left-0 right-0 bg-red-600 text-white text-center p-3 text-sm z-50">
        برای ارسال درخواست، لطفاً شماره تماس خود را در کادر مربوطه وارد نمایید.
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center p-4">
        <div class="bg-neutral-900 rounded-xl p-8 max-w-sm w-full border border-neutral-800 shadow-2xl">
            <svg class="w-12 h-12 text-white mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h3 class="text-xl font-medium text-white text-center mb-2">درخواست شما ارسال شد!</h3>
            <p class="text-neutral-400 text-sm text-center mb-6">به زودی با شما تماس خواهیم گرفت تا جزئیات پروژه را نهایی کنیم.</p>
            <button onclick="closeModal()" class="w-full bg-white text-black py-2 rounded-lg text-sm font-medium transition duration-200 hover:bg-neutral-200">
                باشه، متشکرم
            </button>
        </div>
    </div>

    <!-- Main Content Wrapper to handle margin in landscape -->
    <div class="main-content-wrapper">
        <div class="max-w-4xl mx-auto p-6 md:p-12">
            
            <!-- Header & Logo (Left aligned, Outfit font applied, aesthero is Semibold) -->
            <header class="mb-10 border-b border-neutral-800 pb-6 text-left">
                <h1 class="text-3xl md:text-5xl font-normal tracking-tighter mb-1 logo-font">
                    <!-- aesthero: White, Semibold (font-semibold = 600 in Outfit) -->
                    <span class="font-semibold text-white">aesthero</span><!-- NO SPACE HERE -->
                    <!-- studio: Gray, Light (font-light = 300 in Outfit) -->
                    <span class="text-neutral-500 font-light">studio</span>
                </h1>
                <p class="text-neutral-500 text-sm font-light mt-2">سیستم برآورد هزینه خدمات سه‌بعدی</p>
            </header>

            <!-- FORM START -->
            <!-- The form action is set to the provided FormSubmit endpoint -->
            <form id="pricingForm" method="POST" action="https://formsubmit.co/el/bozaci" onsubmit="handleSubmit(event)">
                
                <!-- FormSubmit Configuration Fields (Hidden) -->
                <!-- Disable Captcha -->
                <input type="hidden" name="_captcha" value="false">
                <!-- Use clean email template -->
                <input type="hidden" name="_template" value="box">
                <!-- Dynamic fields like _subject and _body are added in JavaScript before submission -->


                <!-- Section 1: Client & Project Info -->
                <section class="mb-10 space-y-5">
                    <h2 class="text-sm font-medium text-white mb-5 flex items-center gap-3">
                        <span class="w-1 h-4 bg-white block"></span>
                        اطلاعات سفارش‌دهنده
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                        <div>
                            <label class="block text-sm text-neutral-400 mb-2 uppercase tracking-wider">نام برند</label>
                            <!-- Added name="Brand" -->
                            <input type="text" id="brandName" name="Brand" class="studio-input w-full p-3 rounded-none text-sm" placeholder="نام برند شما">
                        </div>
                        <div>
                            <label class="block text-sm text-neutral-400 mb-2 uppercase tracking-wider">نام سفارش‌دهنده</label>
                            <!-- Added name="Client_Name" -->
                            <input type="text" id="clientName" name="Client_Name" class="studio-input w-full p-3 rounded-none text-sm" placeholder="آقای/خانم...">
                        </div>
                        <div>
                            <label class="block text-sm text-neutral-400 mb-2 uppercase tracking-wider">شماره تماس (الزامی)</label>
                            <div class="flex gap-2" id="phoneContainer">
                                <!-- Added name="Phone_Number" -->
                                <input type="tel" id="phoneNumber" name="Phone_Number" class="studio-input w-2/3 p-3 rounded-none text-sm text-left" placeholder="۹۱۲۰۰۰۰۰۰۰">
                                <!-- Added name="Country_Code" -->
                                <select id="countryCode" name="Country_Code" class="studio-select p-3 rounded-none text-sm w-1/3 text-left">
                                    <option value="+98" selected>+98 (ایران)</option>
                                    <option value="+49">+49 (آلمان)</option>
                                    <option value="+374">+374 (ارمنستان)</option>
                                    <option value="+964">+964 (عراق)</option>
                                    <option value="+90">+90 (ترکیه)</option>
                                    <option value="+971">+971 (امارات)</option>
                                    <option value="+1">+1 (آمریکا)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="w-full">
                        <label class="block text-sm text-neutral-400 mb-2 uppercase tracking-wider">نام محصول و توضیحات پروژه</label>
                        <!-- Added name="Project_Description" -->
                        <textarea id="productDesc" name="Project_Description" class="studio-input w-full p-3 rounded-none text-sm h-20" placeholder="شرح مختصری از محصول، نیازها یا مرجع مدل‌سازی..."></textarea>
                    </div>
                </section>

                <!-- Section 2: Pricing Configuration -->
                
                <!-- Modeling Level -->
                <section class="mb-10">
                    <h2 class="text-sm font-medium text-white mb-5 flex items-center gap-3">
                        <span class="w-1 h-4 bg-white block"></span>
                        سطح مدل‌سازی و متریال
                    </h2>
                    <!-- Hidden input to store selected value for FormSubmit -->
                    <input type="hidden" id="modelingLevel" name="Modeling_Level" value="متوسط (20,000,000 تومان)">

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="select-card p-5 cursor-pointer" data-price="10" onclick="selectModel(10, this)">
                            <div class="text-lg font-medium mb-1">ساده</div>
                            <div class="sub-text text-neutral-500 text-xs">۱۰ میلیون تومان</div>
                        </div>
                        <div class="select-card p-5 cursor-pointer active" data-price="20" onclick="selectModel(20, this)">
                            <div class="text-lg font-medium mb-1">متوسط</div>
                            <div class="sub-text text-neutral-500 text-xs">۲۰ میلیون تومان</div>
                        </div>
                        <div class="select-card p-5 cursor-pointer" data-price="30" onclick="selectModel(30, this)">
                            <div class="text-lg font-medium mb-1">پیچیده</div>
                            <div class="sub-text text-neutral-500 text-xs">۳۰ میلیون تومان</div>
                        </div>
                    </div>
                </section>

                <!-- Frames Slider -->
                <section class="mb-10">
                    <h2 class="text-sm font-medium text-white mb-5 flex items-center gap-3">
                        <span class="w-1 h-4 bg-white block"></span>
                        تعداد کل فریم‌ها (پایه: ۴.۷ میلیون تومان)
                    </h2>
                    <div class="bg-neutral-900/50 p-6 border border-neutral-800">
                        <div class="flex justify-between items-end mb-5">
                            <span class="text-neutral-400 text-xs">تعداد فریم‌های نهایی درخواستی</span>
                            <span class="text-4xl font-light text-white" id="frameDisplay">8</span>
                        </div>
                        <!-- Added name="Total_Frames" -->
                        <input type="range" min="1" max="20" value="8" class="studio-slider mb-4" id="frameSlider" name="Total_Frames" oninput="updateTotalFrames(this.value)">
                        <div class="flex justify-between text-[10px] text-neutral-600 uppercase tracking-widest">
                            <span>۱ فریم</span>
                            <span>۲۰ فریم (حداکثر)</span>
                        </div>
                    </div>
                </section>

                <!-- Add-ons Grid -->
                <section class="mb-8">
                    <h2 class="text-sm font-medium text-white mb-5 flex items-center gap-3">
                        <span class="w-1 h-4 bg-white block"></span>
                        جزئیات سفارش
                    </h2>
                    
                    <div class="grid grid-cols-1 gap-4">
                        
                        <!-- Composition -->
                        <div class="border border-neutral-800 p-5 flex flex-col sm:flex-row justify-between items-center gap-4 bg-neutral-900/20">
                            <div class="text-center sm:text-left">
                                <div class="text-sm text-white font-medium">چیدمان و ترکیب‌بندی پیچیده</div>
                                <div class="text-xs text-neutral-500 mt-1">اضافه بها برای هر فریم: **۳۰٪**</div>
                            </div>
                            <div class="flex flex-col items-center gap-2">
                                <span class="text-xs text-neutral-500 uppercase">تعداد</span>
                                <div class="flex items-center gap-3">
                                    <div class="btn-counter" onclick="updateSubCount('comp', -1)">-</div>
                                    <!-- Hidden input for submission -->
                                    <input type="hidden" id="count-comp" name="Comp_Frames" value="0">
                                    <span class="w-4 text-center text-sm" id="val-comp">0</span>
                                    <div class="btn-counter" onclick="updateSubCount('comp', 1)">+</div>
                                </div>
                            </div>
                        </div>

                        <!-- Resolution -->
                        <div class="border border-neutral-800 p-5 flex flex-col sm:flex-row justify-between items-center gap-4 bg-neutral-900/20">
                            <div class="text-center sm:text-left">
                                <div class="text-sm text-white font-medium">رزولوشن خروجی بالاتر</div>
                                <div class="text-xs text-neutral-500 mt-1">۴K **(+۱۵٪)** | ۸K **(+۳۰٪)**</div>
                            </div>
                            <div class="flex gap-6">
                                <div class="flex flex-col items-center gap-2">
                                    <span class="text-xs text-neutral-500 uppercase">تعداد 4K</span>
                                    <div class="flex items-center gap-3">
                                        <div class="btn-counter" onclick="updateSubCount('res4k', -1)">-</div>
                                        <!-- Hidden input for submission -->
                                        <input type="hidden" id="count-res4k" name="4K_Frames" value="0">
                                        <span class="w-4 text-center text-sm" id="val-res4k">0</span>
                                        <div class="btn-counter" onclick="updateSubCount('res4k', 1)">+</div>
                                    </div>
                                </div>
                                <div class="flex flex-col items-center gap-2">
                                    <span class="text-xs text-neutral-500 uppercase">تعداد 8K</span>
                                    <div class="flex items-center gap-3">
                                        <div class="btn-counter" onclick="updateSubCount('res8k', -1)">-</div>
                                        <!-- Hidden input for submission -->
                                        <input type="hidden" id="count-res8k" name="8K_Frames" value="0">
                                        <span class="w-4 text-center text-sm" id="val-res8k">0</span>
                                        <div class="btn-counter" onclick="updateSubCount('res8k', 1)">+</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- FX -->
                        <div class="border border-neutral-800 p-5 flex flex-col sm:flex-row justify-between items-center gap-4 bg-neutral-900/20">
                            <div class="text-center sm:text-left">
                                <div class="text-sm text-white font-medium">شبیه‌سازی و جلوه‌های ویژه</div>
                                <div class="text-xs text-neutral-500 mt-1">سبک **(+۳۰٪)** | سنگین **(+۶۰٪)**</div>
                            </div>
                            <div class="flex gap-6">
                                <div class="flex flex-col items-center gap-2">
                                    <span class="text-xs text-neutral-500 uppercase">تعداد FX سبک</span>
                                    <div class="flex items-center gap-3">
                                        <div class="btn-counter" onclick="updateSubCount('fxLight', -1)">-</div>
                                        <!-- Hidden input for submission -->
                                        <input type="hidden" id="count-fxLight" name="FX_Light_Frames" value="0">
                                        <span class="w-4 text-center text-sm" id="val-fxLight">0</span>
                                        <div class="btn-counter" onclick="updateSubCount('fxLight', 1)">+</div>
                                    </div>
                                </div>
                                <div class="flex flex-col items-center gap-2">
                                    <span class="text-xs text-neutral-500 uppercase">تعداد FX سنگین</span>
                                    <div class="flex items-center gap-3">
                                        <div class="btn-counter" onclick="updateSubCount('fxHeavy', -1)">-</div>
                                        <!-- Hidden input for submission -->
                                        <input type="hidden" id="count-fxHeavy" name="FX_Heavy_Frames" value="0">
                                        <span class="w-4 text-center text-sm" id="val-fxHeavy">0</span>
                                        <div class="btn-counter" onclick="updateSubCount('fxHeavy', 1)">+</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </section>
            </form>
            <!-- FORM END -->
        </div>
    </div>
    
    <!-- Sticky Footer -->
    <div class="fixed bottom-0 left-0 right-0 glass-footer z-50 p-4 md:p-6" id="sticky-footer">
        <div class="max-w-4xl mx-auto flex justify-between items-center transition-all duration-500 ease-in-out">
            
            <!-- Price Block -->
            <div class="flex-grow">
                <div class="text-xs text-neutral-500 uppercase tracking-widest mb-1">مبلغ کل برآورد (تومان)</div>
                <div class="text-3xl md:text-4xl font-light text-white tracking-tight leading-tight transition-all duration-500 ease-in-out" id="totalCostDisplay">57,600,000</div>
            </div>

            <!-- Payment Schedule -->
            <div class="hidden md:flex gap-8 text-xs text-neutral-400 border-r border-neutral-800 pr-8">
                <div>
                    <div class="text-neutral-600 mb-1">مرحله ۱ (۳۳٪)</div>
                    <div class="text-white transition-all duration-500 ease-in-out" id="pay-1">0</div>
                </div>
                <div>
                    <div class="text-neutral-600 mb-1">مرحله ۲ (۳۳٪)</div>
                    <div class="text-white transition-all duration-500 ease-in-out" id="pay-2">0</div>
                </div>
                <div>
                    <div class="text-neutral-600 mb-1">مرحله ۳ (۳۴٪)</div>
                    <div class="text-white transition-all duration-500 ease-in-out" id="pay-3">0</div>
                </div>
            </div>

            <!-- Action Button -->
            <!-- Changed type to 'submit' to trigger form, added a loading spinner -->
            <button type="submit" form="pricingForm" id="send-request-button" class="w-1/3 min-w-[180px] md:w-auto btn-primary py-3 px-6 rounded text-sm font-medium tracking-wide ml-4">
                <span id="button-text">ارسال درخواست</span>
                <span id="button-loader" class="hidden">
                    <svg class="animate-spin h-5 w-5 text-black" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </span>
            </button>
        </div>

        <!-- Mobile Payment Schedule -->
        <div class="md:hidden mt-4 pt-4 border-t border-neutral-800 grid grid-cols-3 gap-2 text-xs">
            <div>
                <span class="text-neutral-500 block">مرحله ۱ (۳۳٪)</span>
                <span class="text-white" id="pay-1-m">0</span>
            </div>
            <div>
                <span class="text-neutral-500 block">مرحله ۲ (۳۳٪)</span>
                <span class="text-white" id="pay-2-m">0</span>
            </div>
            <div>
                <span class="text-neutral-500 block">مرحله ۳ (۳۴٪)</span>
                <span class="text-white" id="pay-3-m">0</span>
            </div>
        </div>
    </div>

    <script>
        // --- Constants & State ---
        const BASE_FRAME_PRICE = 4700000;
        const FORMSUBMIT_URL = "https://formsubmit.co/el/bozaci";
        
        let state = {
            modelingPrice: 20000000,
            modelingLabel: "متوسط",
            totalFrames: 8,
            counts: { res4k: 0, res8k: 0, comp: 0, fxLight: 0, fxHeavy: 0 }
        };

        // --- Utils ---
        // Function to format price with Toman and comma separation
        const formatMoneyFull = (n) => new Intl.NumberFormat('fa-IR').format(Math.round(n)) + ' تومان';
        // Function to format price with comma separation (used in payment schedule)
        const formatMoneyShort = (n) => new Intl.NumberFormat('fa-IR').format(Math.round(n)); 
        const getEl = (id) => document.getElementById(id);
        const setElValue = (id, value) => {
            const el = getEl(id);
            if (el) el.value = value;
        };

        // --- Core Logic ---
        
        function selectModel(priceInMillions, element) {
            state.modelingPrice = priceInMillions * 1000000;
            state.modelingLabel = priceInMillions === 10 ? "ساده" : (priceInMillions === 20 ? "متوسط" : "پیچیده");
            
            document.querySelectorAll('.select-card').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            
            // Update hidden input for form submission
            getEl('modelingLevel').value = `${state.modelingLabel} (${formatMoneyShort(state.modelingPrice)} تومان)`;

            calculate();
        }

        function updateTotalFrames(val) {
            const newVal = parseInt(val);
            state.totalFrames = newVal;
            getEl('frameDisplay').innerText = newVal;
            validateCounts();
            calculate();
        }

        function updateSubCount(type, change) {
            const currentVal = state.counts[type];
            const newVal = currentVal + change;
            if (newVal < 0) return;

            // --- Validation rules based on totalFrames ---
            const { totalFrames } = state;
            
            // Composition Check (Cannot exceed totalFrames)
            if (type === 'comp' && newVal > totalFrames) return;

            // Resolution Check (res4k + res8k <= totalFrames)
            if (type === 'res4k' && (newVal + state.counts.res8k > totalFrames)) return;
            if (type === 'res8k' && (newVal + state.counts.res4k > totalFrames)) return;

            // FX Check (fxLight + fxHeavy <= totalFrames)
            if (type === 'fxLight' && (newVal + state.counts.fxHeavy > totalFrames)) return;
            if (type === 'fxHeavy' && (newVal + state.counts.fxLight > totalFrames)) return;


            state.counts[type] = newVal;
            getEl(`val-${type}`).innerText = newVal;
            // Update hidden input for form submission
            setElValue(`count-${type}`, newVal);
            calculate();
        }

        function validateCounts() {
            const { totalFrames, counts } = state;
            
            // Re-check and adjust counts if totalFrames was decreased
            if (counts.comp > totalFrames) { state.counts.comp = totalFrames; }
            
            if (counts.res4k + counts.res8k > totalFrames) {
                // Prioritize 4K, reduce 8K
                state.counts.res8k = Math.max(0, totalFrames - counts.res4k);
                // If reducing 8K still doesn't fix it (e.g., 4K is too high), reduce 4K
                if (state.counts.res8k === 0 && counts.res4k > totalFrames) state.counts.res4k = totalFrames;
            }

            if (counts.fxLight + counts.fxHeavy > totalFrames) {
                // Prioritize Light FX, reduce Heavy FX
                state.counts.fxHeavy = Math.max(0, totalFrames - counts.fxLight);
                // If reducing Heavy FX still doesn't fix it (e.g., Light FX is too high), reduce Light FX
                if (state.counts.fxHeavy === 0 && counts.fxLight > totalFrames) state.counts.fxLight = totalFrames;
            }

            // Update UI elements after validation
            for (let key in state.counts) {
                getEl(`val-${key}`).innerText = state.counts[key];
                setElValue(`count-${key}`, state.counts[key]);
            }
        }
        
        function calculate() {
            validateCounts(); // Ensure all counts are valid before calculation

            // 1. Base Costs
            const baseRenderCost = state.totalFrames * BASE_FRAME_PRICE;
            
            // 2. Extra Costs (Surcharges)
            const cost4k = state.counts.res4k * (BASE_FRAME_PRICE * 0.15);
            const cost8k = state.counts.res8k * (BASE_FRAME_PRICE * 0.30);
            const costComp = state.counts.comp * (BASE_FRAME_PRICE * 0.30);
            const costFxL = state.counts.fxLight * (BASE_FRAME_PRICE * 0.30);
            const costFxH = state.counts.fxHeavy * (BASE_FRAME_PRICE * 0.60);

            const totalSurcharges = cost4k + cost8k + costComp + costFxL + costFxH;
            const grandTotal = state.modelingPrice + baseRenderCost + totalSurcharges;

            // Payment Stages (33% / 33% / 34%)
            const pay1 = grandTotal * 0.33;
            const pay2 = grandTotal * 0.33;
            const pay3 = grandTotal * 0.34;

            // Update UI
            getEl('totalCostDisplay').innerText = formatMoneyShort(grandTotal);
            getEl('pay-1').innerText = formatMoneyFull(pay1);
            getEl('pay-2').innerText = formatMoneyFull(pay2);
            getEl('pay-3').innerText = formatMoneyFull(pay3);
            getEl('pay-1-m').innerText = formatMoneyFull(pay1);
            getEl('pay-2-m').innerText = formatMoneyFull(pay2);
            getEl('pay-3-m').innerText = formatMoneyFull(pay3);

            // Return detailed costs for FormSubmit body creation
            return { grandTotal, baseRenderCost, cost4k, cost8k, costComp, costFxL, costFxH, pay1, pay2, pay3 };
        }

        // --- UX Functions ---

        function showValidationFeedback() {
            const phoneInput = getEl('phoneNumber');
            const validationMsg = getEl('validationMessage');
            
            validationMsg.innerText = "برای ارسال درخواست، لطفاً شماره تماس خود را در کادر مربوطه وارد نمایید.";
            validationMsg.classList.add('active');
            phoneInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            phoneInput.classList.add('error-highlight');
            
            setTimeout(() => {
                phoneInput.classList.remove('error-highlight');
                validationMsg.classList.remove('active');
            }, 3000); 
        }

        function showModal() {
            getEl('successModal').classList.add('active');
        }

        window.closeModal = function() {
            getEl('successModal').classList.remove('active');
            // Optional: Reload the page or reset the form after closing modal
            document.getElementById('pricingForm').reset();
            // Re-calculate to reset UI state (assuming default values are the same as initial load)
            window.location.reload(); 
        }

        function setButtonLoading(isLoading) {
            const btn = getEl('send-request-button');
            const text = getEl('button-text');
            const loader = getEl('button-loader');

            if (isLoading) {
                btn.classList.add('loading');
                text.classList.add('hidden');
                loader.classList.remove('hidden');
                btn.disabled = true;
            } else {
                btn.classList.remove('loading');
                text.classList.remove('hidden');
                loader.classList.add('hidden');
                btn.disabled = false;
            }
        }

        // --- Request Submission (FormSubmit AJAX) ---

        window.handleSubmit = async function(event) {
            event.preventDefault(); // Prevent default form redirection
            
            const phoneNumber = getEl('phoneNumber').value.trim();
            if (!phoneNumber) {
                showValidationFeedback();
                return;
            }

            setButtonLoading(true);

            // 1. Calculate final data
            const data = calculate();
            const date = new Date().toLocaleDateString('fa-IR');
            
            // 2. Build the detailed report (This will be the main email body)
            const brandName = getEl('brandName').value || "وارد نشده";
            const clientName = getEl('clientName').value || "وارد نشده";
            const fullPhone = getEl('countryCode').value + ' ' + phoneNumber;
            const projectDesc = getEl('productDesc').value || "وارد نشده";

            // FormSubmit relies on field names. We create a detailed, custom _body field for clean formatting.
            const emailBody = `
**درخواست جدید برآورد هزینه از aesthero studio**

**تاریخ ثبت:** ${date}

--- اطلاعات سفارش‌دهنده ---
* **نام برند:** ${brandName}
* **نام سفارش‌دهنده:** ${clientName}
* **شماره تماس:** ${fullPhone}
* **توضیحات پروژه:**
${projectDesc}

--- خلاصه هزینه (مبلغ نهایی: ${formatMoneyFull(data.grandTotal)}) ---
* **سطح مدل‌سازی:** ${state.modelingLabel} (${formatMoneyFull(state.modelingPrice)})
* **تعداد کل فریم (پایه):** ${state.totalFrames} فریم (${formatMoneyFull(data.baseRenderCost)})

--- جزئیات سفارش ---
* **چیدمان پیچیده (+۳۰٪):** ${state.counts.comp} فریم (اضافه بها: ${formatMoneyFull(data.costComp)})
* **رزولوشن 4K (+۱۵٪):** ${state.counts.res4k} فریم (اضافه بها: ${formatMoneyFull(data.cost4k)})
* **رزولوشن 8K (+۳۰٪):** ${state.counts.res8k} فریم (اضافه بها: ${formatMoneyFull(data.cost8k)})
* **FX سبک (+۳۰٪):** ${state.counts.fxLight} فریم (اضافه بها: ${formatMoneyFull(data.costFxL)})
* **FX سنگین (+۶۰٪):** ${state.counts.fxHeavy} فریم (اضافه بها: ${formatMoneyFull(data.costFxH)})

--- شرایط پرداخت (تومان) ---
* **مرحله اول (۳۳٪):** ${formatMoneyShort(data.pay1)}
* **مرحله دوم (۳۳٪):** ${formatMoneyShort(data.pay2)}
* **مرحله سوم (۳۴٪):** ${formatMoneyShort(data.pay3)}

این یک برآورد اتوماتیک است. لطفا در اسرع وقت برای نهایی‌سازی با مشتری تماس بگیرید.
`;
            
            // 3. Prepare FormData
            const form = getEl('pricingForm');
            const formData = new FormData(form);

            // Add dynamic fields
            formData.append('_subject', `درخواست برآورد هزینه از ${brandName} - ${clientName}`);
            formData.append('Total_Estimated_Cost', formatMoneyFull(data.grandTotal));
            formData.append('Payment_Stage_1', formatMoneyShort(data.pay1));
            formData.append('Payment_Stage_2', formatMoneyShort(data.pay2));
            formData.append('Payment_Stage_3', formatMoneyShort(data.pay3));
            // Overwrite the main body with the detailed report
            formData.append('_body', emailBody); 

            try {
                // Use fetch for AJAX submission to prevent page reload
                const response = await fetch(FORMSUBMIT_URL, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        // Crucial for AJAX submission to FormSubmit to receive JSON response
                        'Accept': 'application/json' 
                    }
                });

                if (response.ok) {
                    showModal();
                } else {
                    console.error('FormSubmit error:', await response.json());
                    // Fallback visual feedback for failed submission
                    getEl('validationMessage').innerText = "خطا در ارسال درخواست. لطفا مجددا تلاش کنید.";
                    getEl('validationMessage').classList.add('active', 'bg-red-800');
                    setTimeout(() => getEl('validationMessage').classList.remove('active', 'bg-red-800'), 5000);
                }

            } catch (error) {
                console.error('Network or CORS error:', error);
                getEl('validationMessage').innerText = "خطای شبکه. لطفا اتصال اینترنت خود را بررسی کنید.";
                getEl('validationMessage').classList.add('active', 'bg-red-800');
                setTimeout(() => getEl('validationMessage').classList.remove('active', 'bg-red-800'), 5000);
            } finally {
                setButtonLoading(false);
            }
        }


        // --- Scroll Animation Logic ---
        function handleScroll() {
            const footer = getEl('sticky-footer');
            const mainContentWrapper = document.querySelector('.main-content-wrapper');
            
            const isLandscape = window.innerWidth < 1024 && window.matchMedia("(orientation: landscape)").matches;
            
            let scrollThreshold;
            
            if (isLandscape) {
                // Calculate threshold based on main content scroll
                scrollThreshold = mainContentWrapper.scrollHeight - mainContentWrapper.clientHeight - 100;
                
                if (window.scrollY >= scrollThreshold) {
                    footer.classList.add('resize');
                    mainContentWrapper.classList.add('resize');
                } else {
                    footer.classList.remove('resize');
                    mainContentWrapper.classList.remove('resize');
                }
            } else {
                // Calculate threshold based on total body scroll (for portrait/desktop)
                scrollThreshold = document.body.scrollHeight - window.innerHeight - 200; 
                
                if (window.scrollY >= scrollThreshold) {
                    footer.classList.add('resize');
                } else {
                    footer.classList.remove('resize');
                }
                // Ensure landscape classes are removed in portrait mode
                mainContentWrapper.classList.remove('resize'); 
            }
        }

        // --- Init ---
        window.addEventListener('scroll', handleScroll);
        window.addEventListener('resize', handleScroll); 
        window.addEventListener('load', () => {
             // Set initial values and styles
             selectModel(20, document.querySelector('.select-card[data-price="20"]'));
             calculate(); 
             handleScroll(); // Check initial state for button visibility
        });

    </script>
</body>
</html>

